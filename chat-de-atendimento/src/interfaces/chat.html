<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Chat WhatsApp</title>
  <style>
  :root {
    --bg: #efeae2; --panel:#f0f2f5; --text:#111; --muted:#667781; --accent:#00a884; --bubble:#fff; --sent:#d9fdd3;
  }
  [data-theme="dark"] {
    --bg:#0b141a; --panel:#202c33; --text:#e9edef; --muted:#8696a0; --accent:#00a884; --bubble:#1f2c33; --sent:#005c4b;
  }
  body { background: var(--bg); color: var(--text); }
  .sidebar { background: var(--panel); }
  .chat-area { background: var(--bg); }
  .message.received { background: var(--bubble); }
  .message.sent { background: var(--sent); }
  .chat-header { background: var(--panel); }
  .input-area { background: var(--panel); }
  </style>
  
  <!-- UX Components -->
  <script src="./notificacoes-toast.js"></script>
  <script src="./estados-carregamento.js"></script>
  <script src="./modal-confirmacao.js"></script>
</head>
<body>
  <div class="container">
    <!-- Lista de Chats -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2 id="clientName">WhatsApp</h2>
        <button onclick="recarregarChats()" style="background:transparent;border:none;color:#fff;cursor:pointer;">ðŸ”„</button>
      </div>
      <div class="search-box">
        <input id="searchInput" placeholder="Buscar conversa..." />
      </div>
      <div class="chat-list" id="chatList">
        <div style="padding:20px;text-align:center;color:#667781;">Carregando...</div>
      </div>
      <div class="quick-messages-toggle" onclick="toggleQuickMessages()" style="padding:8px 12px;cursor:pointer;border-top:1px solid #ccc;font-size:14px;background:var(--panel);">âš¡ Mensagens RÃ¡pidas</div>
      <div class="quick-messages-panel" id="quickPanel" style="display:none;max-height:220px;overflow:auto;background:var(--panel);border-top:1px solid #ccc;">
        <div style="padding:12px;font-size:13px;color:var(--muted);">Carregando...</div>
      </div>
    </div>

    <!-- Ãrea de Conversa -->
    <div class="chat-area" id="chatArea">
      <div class="empty-state">Selecione uma conversa para comeÃ§ar</div>
    </div>
    <div style="position:fixed;bottom:24px;right:24px;z-index:1000;">
      <button id="btnTreinarIA" style="padding:12px 20px;background:#6366f1;color:#fff;border:none;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);font-weight:600;cursor:pointer;">ðŸ¤– Treinar IA Provedor</button>
    </div>
  </div>

  <script>
  // Inicializar Toast e Loading
  const toast = new ToastNotification();
  const loadingState = new LoadingState();
  const confirmModal = new ConfirmationModal();
  
  // Tema
  (async () => {
    const t = await window.electronAPI.getTheme();
    document.documentElement.setAttribute('data-theme', t.theme || 'light');
  })();

  let currentClientId = null;
  let currentChatId = null;
  let allChats = [];
  const currentUser = 'admin'; // substitua pelo usuÃ¡rio logado se tiver contexto

  // Recebe clientId
  window.chatAPI.aoDefinirCliente((clientId) => {
    currentClientId = clientId;
    document.getElementById('clientName').textContent = `WhatsApp (${clientId})`;
    carregarChats();
  });

  // Recebe nova mensagem
  window.chatAPI.aoNovaMensagem((data) => {
    if (data.clientId !== currentClientId) return;
    
    // Atualiza lista de chats
    carregarChats();
    
    // Se Ã© do chat atual, adiciona na conversa
    if (data.chatId === currentChatId) {
      adicionarMensagem(data.mensagem, false);
    }
  });

  async function carregarChats() {
    const res = await window.chatAPI.listarChats(currentClientId);
    if (res.success) {
      allChats = res.chats;
      renderizarChats(allChats);
    }
  }

  function renderizarChats(chats) {
    const lista = document.getElementById('chatList');
    
    if (chats.length === 0) {
      lista.innerHTML = '<div style="padding:20px;text-align:center;color:#667781;">Nenhuma conversa</div>';
      return;
    }

    lista.innerHTML = chats.map(chat => `
      <div class="chat-item ${chat.id === currentChatId ? 'active' : ''}" onclick="abrirChat('${chat.id}', '${chat.name}')">
        <div class="chat-avatar">${chat.name[0].toUpperCase()}</div>
        <div class="chat-info">
          <div class="chat-name">${chat.name}</div>
          <div class="chat-preview">...</div>
        </div>
        <div class="chat-meta">
          ${chat.unreadCount > 0 ? `<div class="chat-badge">${chat.unreadCount}</div>` : ''}
        </div>
      </div>
    `).join('');
  }

  async function abrirChat(chatId, chatName) {
    currentChatId = chatId;
    renderizarChats(allChats);

    const chatArea = document.getElementById('chatArea');
    // Obter status de atendimento
    const at = await window.electronAPI.attend.get({ clientId: currentClientId, chatId: currentChatId });
    const responsavel = at?.atendimento?.username || 'â€”';

    chatArea.innerHTML = `
      <div class="chat-header">
        <div class="avatar">${chatName[0].toUpperCase()}</div>
        <div class="info">
          <div class="name">${chatName}</div>
          <div class="status">ResponsÃ¡vel: <strong id="respNome">${responsavel}</strong></div>
        </div>
        <div>
          <button id="btnAssumir" style="padding:8px 12px;border:0;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer">Assumir</button>
          <button id="btnLiberar" style="padding:8px 12px;border:0;border-radius:6px;background:#ef4444;color:#fff;cursor:pointer">Liberar</button>
        </div>
      </div>
      <div class="messages" id="messages"></div>
      <div class="input-area">
        <input id="messageInput" placeholder="Digite uma mensagem" />
        <button onclick="enviarMensagem()">Enviar</button>
      </div>
    `;

    document.getElementById('btnAssumir').onclick = async () => {
      const r = await window.electronAPI.attend.claim({ username: currentUser, clientId: currentClientId, chatId: currentChatId });
      if (r.success) {
        toast.success(r.message || 'Atendimento assumido com sucesso');
      } else {
        toast.error(r.message || 'Falha ao assumir atendimento');
      }
      const at2 = await window.electronAPI.attend.get({ clientId: currentClientId, chatId: currentChatId });
      document.getElementById('respNome').textContent = at2?.atendimento?.username || 'â€”';
    };
    document.getElementById('btnLiberar').onclick = async () => {
      const r = await window.electronAPI.attend.release({ username: currentUser, clientId: currentClientId, chatId: currentChatId });
      if (r.success) {
        toast.success(r.message || 'Atendimento liberado com sucesso');
      } else {
        toast.error(r.message || 'Falha ao liberar atendimento');
      }
      const at2 = await window.electronAPI.attend.get({ clientId: currentClientId, chatId: currentChatId });
      document.getElementById('respNome').textContent = at2?.atendimento?.username || 'â€”';
    };

    // Carrega histÃ³rico
    const res = await window.chatAPI.carregarHistorico(currentClientId, chatId);
    if (res.success) {
      res.mensagens.forEach(msg => {
        adicionarMensagem(msg, msg.fromMe);
      });
    }

    // Enter para enviar
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') enviarMensagem();
    });
  }

  function adicionarMensagem(msg, enviada) {
    const messagesDiv = document.getElementById('messages');
    if (!messagesDiv) return;

    const div = document.createElement('div');
    div.className = `message ${enviada ? 'sent' : 'received'}`;
    div.innerHTML = `
      <div class="message-body">${msg.body || ''}</div>
      <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
    `;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  async function enviarMensagem() {
    const input = document.getElementById('messageInput');
    const texto = input.value.trim();
    if (!texto || !currentChatId) return;

    // Slash command: /codigo => expandir mensagem rÃ¡pida
    if (texto.startsWith('/')) {
      const codigo = texto.slice(1).trim();
      if (codigo) {
        const r = await window.chatAPI.obterMensagemRapida(codigo);
        if (r.success && r.mensagem) {
          input.value = r.mensagem.texto; // substitui pelo texto expandido
          // registra uso
          window.chatAPI.registrarUsoMensagemRapida(codigo);
        } else {
          toast.error('Atalho nÃ£o encontrado');
          return;
        }
      }
    }

    const btnEnviar = event?.target || document.querySelector('.input-area button');
    if (btnEnviar) loadingState.button(btnEnviar, true);
    
    try {
      const res = await window.chatAPI.enviarMensagem(currentClientId, currentChatId, texto);
      if (res.success) {
        adicionarMensagem({ body: texto, timestamp: Date.now() }, true);
        input.value = '';
        toast.success('Mensagem enviada');
      } else {
        toast.error('Erro ao enviar: ' + res.message);
      }
    } catch (error) {
      toast.error('Erro ao enviar mensagem: ' + error.message);
    } finally {
      if (btnEnviar) loadingState.button(btnEnviar, false);
    }
  }

  function recarregarChats() {
    carregarChats();
  }

  // Quick Messages UI
  async function carregarMensagensRapidas() {
    const painel = document.getElementById('quickPanel');
    const res = await window.chatAPI.listarMensagensRapidas();
    if (!res.success) {
      painel.innerHTML = '<div style="padding:12px;color:#f00;">Erro ao carregar</div>';
      return;
    }
    if (res.mensagens.length === 0) {
      painel.innerHTML = '<div style="padding:12px;color:var(--muted);">Nenhuma mensagem rÃ¡pida</div>';
      return;
    }
    painel.innerHTML = res.mensagens.map(m => `
      <div class="qm-item" style="padding:8px 12px;border-bottom:1px solid #ccc;font-size:13px;cursor:pointer;" onclick="inserirMensagemRapida('${m.codigo.replace(/'/g, '')}')">
        <strong>/${m.codigo}</strong><br/><span style="color:var(--muted);">${m.texto.substring(0,90)}${m.texto.length>90?'...':''}</span>
      </div>
    `).join('');
  }

  function toggleQuickMessages() {
    const painel = document.getElementById('quickPanel');
    if (painel.style.display === 'none') {
      painel.style.display = 'block';
      carregarMensagensRapidas();
    } else {
      painel.style.display = 'none';
    }
  }

  function inserirMensagemRapida(codigo) {
    const input = document.getElementById('messageInput');
    input.value = '/' + codigo;
    input.focus();
  }

  // Busca
  document.getElementById('searchInput').addEventListener('input', (e) => {
    const termo = e.target.value.toLowerCase();
    const filtrados = allChats.filter(chat => 
      chat.name.toLowerCase().includes(termo)
    );
    renderizarChats(filtrados);
  });
  // IntegraÃ§Ã£o Gemini: Treinar IA como agente de provedor
  document.getElementById('btnTreinarIA').onclick = async () => {
    loadingState.show('Treinando IA Gemini...');
    try {
      // Busca intents do provedor
      const res = await fetch('../../dados/provedor-config.json');
      const provedor = await res.json();
      const prompt = `VocÃª Ã© um agente virtual de atendimento de provedor de internet. Responda sempre de forma clara, cordial e objetiva. Use as seguintes intenÃ§Ãµes e exemplos para orientar seu atendimento:\n\n` +
        provedor.intents.map(i => `Intent: ${i.nome}\nPalavras-chave: ${i.palavras.join(', ')}\nResposta: ${i.resposta}${i.passosDiagnostico ? '\nPassos: ' + i.passosDiagnostico.join(' | ') : ''}`).join('\n\n');
      const resposta = await window.iaAPI.perguntarGemini({ mensagem: prompt });
      if (resposta.success) {
        toast.success('IA treinada! Resposta de exemplo: ' + (resposta.resposta?.slice(0,120) || 'ok...'));
      } else {
        toast.error('Falha ao treinar IA: ' + resposta.message);
      }
    } catch (e) {
      toast.error('Erro ao treinar IA: ' + (e.message || e));
    } finally {
      loadingState.hide();
    }
  };
  </script>
  
  <script src="barra-navegacao.js"></script>
  <script>
    initNavigationBar('Chat WhatsApp');
  </script>
</body>
</html>