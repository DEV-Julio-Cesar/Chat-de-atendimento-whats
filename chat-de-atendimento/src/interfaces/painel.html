<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - M√©tricas</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: Arial, sans-serif; background:#f5f5f5; }
    
    header { background:#1f2937; color:#fff; padding:20px 30px; }
    header h1 { font-size:24px; }
    
    .container { padding:30px; max-width:1400px; margin:0 auto; }
    
    .cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin-bottom:30px; }
    .card { background:#fff; padding:24px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
    .card-title { font-size:14px; color:#6b7280; font-weight:600; margin-bottom:8px; }
    .card-value { font-size:36px; font-weight:700; color:#111827; }
    .card-icon { font-size:32px; float:right; opacity:.3; }
    
    .chart-container { background:#fff; padding:24px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.1); margin-bottom:20px; }
    .chart-title { font-size:18px; font-weight:600; margin-bottom:16px; color:#111827; }
    
    .actions { display:flex; gap:12px; margin-bottom:20px; }
    .actions button { padding:12px 20px; background:#1f2937; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
    .actions button:hover { background:#374151; }
    .actions button.danger { background:#ef4444; }
    .actions button.danger:hover { background:#dc2626; }
    
    .progress-bar { width:100%; height:8px; background:#e5e7eb; border-radius:4px; overflow:hidden; margin-top:12px; }
    .progress-fill { height:100%; background:#10b981; transition: width .3s; }
  </style>
  
  <!-- UX Components -->
  <script src="./notificacoes-toast.js"></script>
  <script src="./estados-carregamento.js"></script>
  <script src="./modal-confirmacao.js"></script>
  <!-- Chart.js CDN para gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>üìä Dashboard - M√©tricas do Sistema</h1>
  </header>

  <div class="container">
    <div class="actions">
      <button onclick="atualizarMetricas()">üîÑ Atualizar</button>
      <button onclick="exportar('pdf')">üìÑ Exportar PDF</button>
      <button onclick="exportar('xlsx')">üìä Exportar Excel</button>
      <button class="danger" onclick="resetarMetricas()">üóëÔ∏è Resetar M√©tricas</button>
    </div>

    <div class="cards">
      <div class="card">
        <div class="card-icon">üì®</div>
        <div class="card-title">Mensagens Enviadas</div>
        <div class="card-value" id="enviadas">0</div>
        <div class="progress-bar"><div class="progress-fill" id="prog-enviadas"></div></div>
      </div>

      <div class="card">
        <div class="card-icon">üì¨</div>
        <div class="card-title">Mensagens Recebidas</div>
        <div class="card-value" id="recebidas">0</div>
        <div class="progress-bar"><div class="progress-fill" id="prog-recebidas"></div></div>
      </div>

      <div class="card">
        <div class="card-icon">üí¨</div>
        <div class="card-title">Total de Mensagens</div>
        <div class="card-value" id="total">0</div>
      </div>

      <div class="card">
        <div class="card-icon">üìä</div>
        <div class="card-title">Taxa de Resposta</div>
        <div class="card-value" id="taxa">0%</div>
      </div>

      <div class="card">
        <div class="card-icon">üí¨</div>
        <div class="card-title">Conversas Ativas</div>
        <div class="card-value" id="conversas">0</div>
      </div>

      <div class="card">
        <div class="card-icon">üì±</div>
        <div class="card-title">Clientes Conectados</div>
        <div class="card-value" id="clientes">0</div>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-title">Resumo de Atividades</div>
      <div id="resumo" style="color:#6b7280;padding:20px;">
        Carregando estat√≠sticas...
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-title">Uso de Mensagens R√°pidas (/atalhos)</div>
      <div style="margin-bottom:12px;display:flex;gap:12px;flex-wrap:wrap;">
        <button onclick="atualizarMetricasRapidas()" style="padding:8px 16px;background:#1f2937;color:#fff;border:none;border-radius:6px;cursor:pointer;">üîÑ Atualizar Uso</button>
        <button onclick="resetarMetricasRapidas()" style="padding:8px 16px;background:#ef4444;color:#fff;border:none;border-radius:6px;cursor:pointer;">üóëÔ∏è Resetar Uso</button>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:32px;align-items:flex-start;">
        <div id="quickMetrics" style="overflow:auto;flex:2 1 400px;min-width:350px;">
          <table style="width:100%;border-collapse:collapse;min-width:350px;">
            <thead>
              <tr style="background:#f3f4f6;text-align:left;">
                <th style="padding:10px;border-bottom:1px solid #e5e7eb;">C√≥digo</th>
                <th style="padding:10px;border-bottom:1px solid #e5e7eb;">Uso</th>
                <th style="padding:10px;border-bottom:1px solid #e5e7eb;">% do Total</th>
                <th style="padding:10px;border-bottom:1px solid #e5e7eb;">√öltimo Uso</th>
                <th style="padding:10px;border-bottom:1px solid #e5e7eb;">Barra</th>
              </tr>
            </thead>
            <tbody id="quickMetricsBody">
              <tr><td colspan="5" style="padding:12px;color:#6b7280;">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
        <div style="flex:1 1 320px;min-width:320px;max-width:420px;">
          <canvas id="top5QuickChart" width="400" height="320"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Inicializar Toast e Loading
    const toast = new ToastNotification();
    const loadingState = new LoadingState();
    const confirmModal = new ConfirmationModal();
    
    async function atualizarMetricas() {
      const res = await window.dashboardAPI.obterMetricas();
      
      if (!res.success) {
        toast.error('Erro ao carregar m√©tricas: ' + res.message);
        return;
      }

      const m = res.metricas;
      
      document.getElementById('enviadas').textContent = m.mensagensEnviadas.toLocaleString();
      document.getElementById('recebidas').textContent = m.mensagensRecebidas.toLocaleString();
      document.getElementById('total').textContent = m.totalMensagens.toLocaleString();
      document.getElementById('conversas').textContent = m.totalConversas.toLocaleString();
      document.getElementById('clientes').textContent = m.clientesAtivos.toLocaleString();
      
      const taxa = m.totalMensagens > 0 
        ? ((m.mensagensEnviadas / m.totalMensagens) * 100).toFixed(1)
        : 0;
      document.getElementById('taxa').textContent = taxa + '%';
      
      // Progress bars
      const maxVal = Math.max(m.mensagensEnviadas, m.mensagensRecebidas, 1);
      document.getElementById('prog-enviadas').style.width = 
        ((m.mensagensEnviadas / maxVal) * 100) + '%';
      document.getElementById('prog-recebidas').style.width = 
        ((m.mensagensRecebidas / maxVal) * 100) + '%';
      
      // Resumo
      const agora = new Date();
      document.getElementById('resumo').innerHTML = `
        <p style="margin-bottom:12px;">
          <strong>√öltima atualiza√ß√£o:</strong> ${agora.toLocaleString()}
        </p>
        <p style="margin-bottom:8px;">
          Total de intera√ß√µes: <strong>${m.totalMensagens}</strong>
        </p>
        <p style="margin-bottom:8px;">
          M√©dia de resposta: <strong>${m.mediaResposta}</strong> mensagens recebidas por enviada
        </p>
        <p style="color:#10b981;">
          ‚úÖ Sistema operacional
        </p>
      `;
    }

    async function resetarMetricas() {
      const confirmed = await confirmModal.danger({
        title: 'Resetar M√©tricas',
        message: 'Deseja realmente resetar todas as m√©tricas? Esta a√ß√£o n√£o pode ser desfeita.',
        confirmText: 'Sim, Resetar',
        cancelText: 'Cancelar'
      });
      
      if (!confirmed) return;

      const res = await window.dashboardAPI.resetarMetricas();
      
      if (res.success) {
        toast.success('M√©tricas resetadas com sucesso!');
        atualizarMetricas();
      } else {
        toast.error('Erro ao resetar: ' + res.message);
      }
    }

    async function exportar(tipo) {
      const res = await window.dashboardAPI.exportar(tipo);
      if (res.success) {
        toast.success(`Arquivo gerado: ${res.file}`);
      } else {
        toast.error('Erro: ' + res.message);
      }
    }

    let top5QuickChart = null;
    async function atualizarMetricasRapidas() {
      const res = await window.dashboardAPI.metricasMensagensRapidas();
      const tbody = document.getElementById('quickMetricsBody');
      if (!res || !res.usos) {
        tbody.innerHTML = '<tr><td colspan="5" style="padding:12px;color:#f00;">Erro ao carregar m√©tricas</td></tr>';
        if (top5QuickChart) top5QuickChart.destroy();
        return;
      }
      const entradas = Object.entries(res.usos);
      if (entradas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="padding:12px;color:#6b7280;">Nenhum uso registrado</td></tr>';
        if (top5QuickChart) top5QuickChart.destroy();
        return;
      }
      const total = entradas.reduce((acc, [_k, v]) => acc + v.count, 0) || 1;
      entradas.sort((a,b)=> b[1].count - a[1].count);
      tbody.innerHTML = entradas.map(([codigo, info]) => {
        const pct = ((info.count / total)*100).toFixed(1);
        const last = info.lastUsed ? new Date(info.lastUsed).toLocaleString('pt-BR') : '‚Äî';
        return `<tr>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">/${codigo}</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;">${info.count}</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;">${pct}%</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;">${last}</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;">
            <div style="background:#e5e7eb;height:8px;border-radius:4px;overflow:hidden;min-width:120px;">
              <div style="width:${pct}%;background:#10b981;height:100%;"></div>
            </div>
          </td>
        </tr>`;
      }).join('');

      // Top 5 chart
      const top5 = entradas.slice(0, 5);
      const labels = top5.map(([codigo]) => '/' + codigo);
      const data = top5.map(([_codigo, info]) => info.count);
      const bgColors = [
        '#10b981', '#3b82f6', '#f59e42', '#ef4444', '#6366f1'
      ];
      const ctx = document.getElementById('top5QuickChart').getContext('2d');
      if (top5QuickChart) top5QuickChart.destroy();
      top5QuickChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Usos',
            data,
            backgroundColor: bgColors,
            borderRadius: 8,
            maxBarThickness: 48
          }]
        },
        options: {
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: 'Top 5 Atalhos Mais Usados',
              font: { size: 16 }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { precision:0 }
            }
          }
        }
      });
    }

    async function resetarMetricasRapidas() {
      const confirmed = await confirmModal.danger({
        title: 'Resetar Uso de Atalhos',
        message: 'Tem certeza que deseja limpar todas as m√©tricas de /atalhos?',
        confirmText: 'Resetar',
        cancelText: 'Cancelar'
      });
      if (!confirmed) return;
      const res = await window.dashboardAPI.resetMetricasMensagensRapidas();
      if (res.success) {
        toast.success('Uso de mensagens r√°pidas resetado.');
        atualizarMetricasRapidas();
      } else {
        toast.error('Falha ao resetar m√©tricas r√°pidas');
      }
    }

    // Carrega m√©tricas r√°pidas tamb√©m
    atualizarMetricasRapidas();

    // Atualiza a cada 30 segundos
    setInterval(atualizarMetricas, 30000);
    
    // Carrega inicial
    atualizarMetricas();
  </script>
  
  <script src="barra-navegacao.js"></script>
  <script>
    initNavigationBar('üìä Dashboard - M√©tricas');
  </script>
</body>
</html>